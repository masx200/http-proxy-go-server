name: Build and Publish Docker Image

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥è·å–æ­£ç¡®çš„Gitå“ˆå¸Œ

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Get Git short hash
      id: git_hash
      run: |
        SHORT_HASH=$(git rev-parse --short HEAD)
        echo "short_hash=$SHORT_HASH" >> $GITHUB_OUTPUT
        echo "Git short hash: $SHORT_HASH"

    - name: Get timestamp
      id: timestamp
      run: |
        TIMESTAMP=$(date +'%Y%m%d%H%M%S')
        echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
        echo "Timestamp: $TIMESTAMP"

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          # å§‹ç»ˆä½¿ç”¨GitçŸ­å“ˆå¸Œä½œä¸ºæ ‡ç­¾
          type=raw,value=${{ steps.git_hash.outputs.short_hash }}
          # mainåˆ†æ”¯ä½¿ç”¨latestæ ‡ç­¾
          type=ref,event=branch,suffix=-${{ steps.git_hash.outputs.short_hash }}
          # developåˆ†æ”¯ä½¿ç”¨developæ ‡ç­¾
          type=ref,event=branch,enable={{is_default_branch}}
          type=ref,event=branch,suffix=-${{ steps.git_hash.outputs.short_hash }},enable={{is_default_branch}}
          # å‘å¸ƒæ ‡ç­¾ä½¿ç”¨ç‰ˆæœ¬å·
          type=ref,event=tag
          # æ·»åŠ æ—¶é—´æˆ³æ ‡ç­¾
          type=raw,value=${{ steps.timestamp.outputs.timestamp }}-{{branch}}-${{ steps.git_hash.outputs.short_hash }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./dockerfile
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: |
          org.opencontainers.image.title=http-proxy-go-server
          org.opencontainers.image.description=A feature-rich HTTP/HTTPS proxy server with DNS caching and AOF persistence
          org.opencontainers.image.url=https://github.com/${{ github.repository }}
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
          org.opencontainers.image.version=${{ steps.git_hash.outputs.short_hash }}
          org.opencontainers.image.created=${{ steps.timestamp.outputs.timestamp }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.licenses=MIT
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64

    - name: Generate image artifacts summary
      if: github.event_name != 'pull_request'
      run: |
        echo "## ğŸš€ Docker Image Published" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“¦ Image Information" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Registry**: ${{ env.REGISTRY }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Repository**: ${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Git Hash**: ${{ steps.git_hash.outputs.short_hash }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Time**: ${{ steps.timestamp.outputs.timestamp }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ·ï¸ Available Tags" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # ç”Ÿæˆæ‰€æœ‰æ ‡ç­¾çš„æ‹‰å–å‘½ä»¤
        for tag in $(echo '${{ steps.meta.outputs.tags }}' | tr ',' '\n'); do
          if [[ $tag == *":"* ]]; then
            echo "- \`$tag\`" >> $GITHUB_STEP_SUMMARY
            echo "  \`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "  docker pull $tag" >> $GITHUB_STEP_SUMMARY
            echo "  \`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
        done

    - name: Run basic tests on built image
      if: github.event_name != 'pull_request'
      run: |
        echo "Testing Docker image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.git_hash.outputs.short_hash }}"

        # å¯åŠ¨å®¹å™¨è¿›è¡ŒåŸºæœ¬æµ‹è¯•
        docker run -d --name test-proxy -p 8080:8080 \
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.git_hash.outputs.short_hash }} \
          -hostname 0.0.0.0 -port 8080

        # ç­‰å¾…å®¹å™¨å¯åŠ¨
        sleep 10

        # æ£€æŸ¥å®¹å™¨æ˜¯å¦åœ¨è¿è¡Œ
        if docker ps | grep test-proxy; then
          echo "âœ… Container is running successfully"
        else
          echo "âŒ Container failed to start"
          docker logs test-proxy
          exit 1
        fi

        # æ¸…ç†æµ‹è¯•å®¹å™¨
        docker stop test-proxy
        docker rm test-proxy
        echo "âœ… Docker image test completed successfully"