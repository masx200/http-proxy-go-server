name: Docker Build with Git Hash Tags

on:
  push:
    branches: [main, master]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # èŽ·å–å®Œæ•´GitåŽ†å²ä»¥è®¡ç®—æ­£ç¡®çš„å“ˆå¸Œ

      - name: Get Git information
        id: git_info
        run: |
          # èŽ·å–å®Œæ•´çš„Gitå“ˆå¸Œ
          FULL_HASH=$(git rev-parse HEAD)
          echo "full_hash=$FULL_HASH" >> $GITHUB_OUTPUT

          # èŽ·å–çŸ­å“ˆå¸Œï¼ˆå‰8ä½ï¼‰
          SHORT_HASH=$(git rev-parse --short HEAD)
          echo "short_hash=$SHORT_HASH" >> $GITHUB_OUTPUT

          # èŽ·å–åˆ†æ”¯å
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          # èŽ·å–æ—¶é—´æˆ³
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT

          echo "Gitä¿¡æ¯:"
          echo "  å®Œæ•´å“ˆå¸Œ: $FULL_HASH"
          echo "  çŸ­å“ˆå¸Œ: $SHORT_HASH"
          echo "  åˆ†æ”¯: $BRANCH_NAME"
          echo "  æ—¶é—´æˆ³: $TIMESTAMP"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:${{ steps.git_info.outputs.short_hash }}
            ghcr.io/${{ github.repository }}:${{ steps.git_info.outputs.branch_name }}
            ghcr.io/${{ github.repository }}:hash-${{ steps.git_info.outputs.full_hash }}
            ghcr.io/${{ github.repository }}:${{ steps.git_info.outputs.timestamp }}
          labels: |
            org.opencontainers.image.title=http-proxy-go-server
            org.opencontainers.image.description=A feature-rich HTTP/HTTPS proxy server with DNS caching and Redis-style AOF persistence
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.revision=${{ steps.git_info.outputs.full_hash }}
            org.opencontainers.image.version=${{ steps.git_info.outputs.short_hash }}
            org.opencontainers.image.created=${{ steps.git_info.outputs.timestamp }}
            org.opencontainers.image.licenses=MIT
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Create release summary
        run: |
          echo "## ðŸ³ Docker Image Published Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Build Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Registry** | \`ghcr.io\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Repository** | \`${{ github.repository }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Git Hash** | \`${{ steps.git_info.outputs.short_hash }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Full Hash** | \`${{ steps.git_info.outputs.full_hash }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ steps.git_info.outputs.branch_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Build Time** | \`${{ steps.git_info.outputs.timestamp }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ·ï¸ Available Tags" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ä¸»è¦æ ‡ç­¾" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **GitçŸ­å“ˆå¸Œæ ‡ç­¾** (æŽ¨èç”¨äºŽç”Ÿäº§):" >> $GITHUB_STEP_SUMMARY
          echo "  \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "  docker pull ghcr.io/${{ github.repository }}:${{ steps.git_info.outputs.short_hash }}" >> $GITHUB_STEP_SUMMARY
          echo "  \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯æ ‡ç­¾** (æŽ¨èç”¨äºŽæµ‹è¯•):" >> $GITHUB_STEP_SUMMARY
          echo "  \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "  docker pull ghcr.io/${{ github.repository }}:${{ steps.git_info.outputs.branch_name }}" >> $GITHUB_STEP_SUMMARY
          echo "  \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Œæ•´å“ˆå¸Œæ ‡ç­¾** (ç”¨äºŽç²¾ç¡®å®šä½):" >> $GITHUB_STEP_SUMMARY
          echo "  \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "  docker pull ghcr.io/${{ github.repository }}:hash-${{ steps.git_info.outputs.full_hash }}" >> $GITHUB_STEP_SUMMARY
          echo "  \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **æ—¶é—´æˆ³æ ‡ç­¾**:" >> $GITHUB_STEP_SUMMARY
          echo "  \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "  docker pull ghcr.io/${{ github.repository }}:${{ steps.git_info.outputs.timestamp }}" >> $GITHUB_STEP_SUMMARY
          echo "  \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸš€ Quick Start" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### è¿è¡Œæœ€æ–°ä¸»åˆ†æ”¯ç‰ˆæœ¬:" >> $GITHUB_STEP_SUMMARY
          echo "  \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "  docker run -d -p 8080:8080 --name http-proxy \\" >> $GITHUB_STEP_SUMMARY
          echo "    ghcr.io/${{ github.repository }}:${{ steps.git_info.outputs.short_hash }} \\" >> $GITHUB_STEP_SUMMARY
          echo "    -hostname 0.0.0.0 -port 8080 \\" >> $GITHUB_STEP_SUMMARY
          echo "    -cache-aof-enabled true \\" >> $GITHUB_STEP_SUMMARY
          echo "    -cache-aof-interval 1s" >> $GITHUB_STEP_SUMMARY
          echo "  \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "#### è¿è¡Œå¸¦DoHé…ç½®çš„ç‰ˆæœ¬:" >> $GITHUB_STEP_SUMMARY
          echo "  \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "  docker run -d -p 8080:8080 --name http-proxy \\" >> $GITHUB_STEP_SUMMARY
          echo "    ghcr.io/${{ github.repository }}:${{ steps.git_info.outputs.short_hash }} \\" >> $GITHUB_STEP_SUMMARY
          echo "    -hostname 0.0.0.0 -port 8080 \\" >> $GITHUB_STEP_SUMMARY
          echo "    -dohurl https://dns.google/dns-query \\" >> $GITHUB_STEP_SUMMARY
          echo "    -dohip 8.8.8.8 \\" >> $GITHUB_STEP_SUMMARY
          echo "    -dohalpn h2 \\" >> $GITHUB_STEP_SUMMARY
          echo "    -cache-aof-enabled true" >> $GITHUB_STEP_SUMMARY
          echo "  \`\`\`" >> $GITHUB_STEP_SUMMARY
