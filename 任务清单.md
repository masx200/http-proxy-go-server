# HTTP 代理服务器 WebSocket 支持任务清单

## 项目现状分析

当前项目是一个基于 Golang 的 HTTP 代理服务器，支持以下功能：

- HTTP/HTTPS 代理
- TLS 认证
- 基本认证
- DOH (DNS over HTTPS)
- 多上游代理配置
- 规则和过滤器系统
- JSON 配置文件支持

## 任务目标

为项目添加 WebSocket 协议作为上游代理的支持，
每一步完成都更新任务清单,包括：

1. 命令行参数支持 WebSocket 上游代理
2. 配置文件支持 WebSocket 上游代理类型
3. 集成 socks5-websocket-proxy-golang 客户端

## 详细任务清单

### 1. 理解现有架构

- [ ] 分析 main.go 中的代理选择逻辑
- [ ] 理解 ProxySelector 函数的工作原理
- [ ] 分析 transportConfigurations 的构建过程
- [ ] 理解 UpStream 结构体和相关配置

### 2. 设计 WebSocket 代理支持

- [ ] 定义 WebSocket 上游代理的配置结构
- [ ] 设计 WebSocket 代理客户端接口
- [ ] 规划与现有代理系统的集成方案

### 3. 修改配置结构

- [ ] 扩展 UpStream 结构体，添加 type 字段
- [ ] 添加 WebSocket 相关配置字段
- [ ] 更新 Config 结构体以支持新配置
- [ ] 修改配置文件解析逻辑

### 4. 添加命令行参数支持

- [ ] 添加-upstream-type 参数
- [ ] 添加-upstream-address 参数
- [ ] 添加-upstream-username 参数
- [ ] 添加-upstream-password 参数
- [ ] 修改 main 函数中的参数解析逻辑

### 5. 集成 WebSocket 客户端

- [ ] 添加 socks5-websocket-proxy-golang 依赖
- [ ] 实现 WebSocket 代理客户端包装器
- [ ] 创建与标准库兼容的代理函数
- [ ] 实现 WebSocket 连接管理

### 6. 修改代理选择逻辑

- [ ] 更新 ProxySelector 函数以支持 WebSocket 类型
- [ ] 修改 transportConfigurations 构建逻辑
- [ ] 实现 WebSocket 代理的 URL 解析
- [ ] 添加 WebSocket 代理的特殊处理逻辑

### 7. 更新配置文件示例

- [ ] 修改 config.json 添加 WebSocket 上游示例
- [ ] 更新 README.md 文档说明新功能
- [ ] 添加使用示例和说明

### 8. 测试和验证

- [ ] 编写单元测试
- [ ] 测试命令行参数功能
- [ ] 测试配置文件功能
- [ ] 验证 WebSocket 代理连接
- [ ] 测试代理转发功能

## 技术要点

### 需要修改的核心文件

1. **main.go** - 添加命令行参数和主要逻辑
2. **config.json** - 更新配置示例
3. **README.md** - 更新文档

### 关键技术实现

1. **代理类型识别** - 在 ProxySelector 中添加 WebSocket 类型判断
2. **WebSocket 客户端集成** - 使用提供的 socks5-websocket-proxy-golang 库
3. **配置扩展** - 保持向后兼容的同时添加新功能
4. **连接管理** - 确保 WebSocket 连接的正确建立和关闭

### 集成方案

```go
// 需要添加的导入
import (

    "github.com/masx200/socks5-websocket-proxy-golang/pkg/interfaces"
    socks5_websocket_proxy_golang_websocket "github.com/masx200/socks5-websocket-proxy-golang/pkg/websocket"
)

// WebSocket代理客户端配置
var config interfaces.ClientConfig = interfaces.ClientConfig{
    Username:   upstreamUsername,
    Password:   upstreamPassword,
    ServerAddr: upstreamAddress,
    Protocol:   "websocket",
    Timeout:    30 * time.Second,
}

// 创建WebSocket客户端
websocketClient := socks5_websocket_proxy_golang_websocket.NewWebSocketClient(config)
```

```golang
// ClientConfig 客户端配置

type ClientConfig struct {

Username   string        `json:"username"`    // 用户名

Password   string        `json:"password"`    // 密码

ServerAddr string        `json:"server_addr"` // 服务器地址

Protocol   string        `json:"protocol"`    // 协议类型

Timeout    time.Duration `json:"timeout"`     // 超时时间

}
// ProxyClient 代理客户端接口

type ProxyClient interface {

Connect(host string, port int) error

// Authenticate(username, password string) error

ForwardData(conn net.Conn) error

Close() error

SetConnectionClosedCallback(callback func()) error

NetConn() net.Conn

}
```

## 配置文件格式扩展

### 新的 UpStream 结构

```json
{
  "upstreams": {
    "http_proxy": {
      "type": "http",
      "proxy_username": "admin",
      "proxy_password": "pass",
      "http_proxy": "http://admin:pass@127.0.0.1:7890",
      "https_proxy": "http://admin:pass@127.0.0.1:7890",
      "bypass_list": ["localhost", "127.0.0.1", "[::1]"]
    },
    "websocket_proxy": {
      "type": "websocket",
      "proxy_username": "admin",
      "proxy_password": "pass",
      "http_proxy": "ws://admin:pass@127.0.0.1:17890",
      "https_proxy": "ws://admin:pass@127.0.0.1:17890",
      "bypass_list": ["localhost", "127.0.0.1", "[::1]"]
    }
  }
}
```

## 命令行参数扩展

### 新增参数

- `-upstream-type`: 代理类型 (http/websocket)
- `-upstream-address`: 上游代理地址
- `-upstream-username`: 上游代理用户名
- `-upstream-password`: 上游代理密码

### 使用示例

```bash
# 使用WebSocket上游代理
go run main.go -upstream-type websocket -upstream-address ws://127.0.0.1:1081 -upstream-username user -upstream-password pass
```

## 实施优先级

1. **高优先级**：理解现有架构、设计 WebSocket 支持、修改配置结构
2. **中优先级**：添加命令行参数、集成 WebSocket 客户端、修改代理选择逻辑
3. **低优先级**：更新文档、测试验证

## 风险评估

## 重要注意事项

### 技术风险

- **WebSocket 代理的特殊性**:
  Golang 标准库的`http.Transport.Proxy`不支持 WebSocket 协议，需要自定义实现<mcreference link="https://www.cnblogs.com/WingPig99/p/5929138.html" index="0">0</mcreference>
- **连接管理复杂性**:
  WebSocket 连接需要特殊的握手协议和消息帧处理，比 HTTP 代理更复杂
- **性能影响**: WebSocket 连接建立开销较大，需要考虑连接复用和池化管理
- **协议兼容性**: 需要确保 WebSocket 代理能够正确处理 HTTP/HTTPS 请求的转发

### 兼容性风险

- **配置文件向后兼容性**: 新增`type`字段需要设置合理的默认值，避免破坏现有配置
- **命令行参数兼容性**: 新增的 WebSocket 相关参数不应与现有参数冲突
- **代理切换逻辑**: 需要确保 WebSocket 代理和 HTTP 代理能够正确切换，不影响现有功能

### 实现难点

- **标准库限制**:
  不能使用`http.ProxyURL()`函数，需要自定义 Dialer 实现<mcreference link="https://www.cnblogs.com/WingPig99/p/5929138.html" index="0">0</mcreference>
- **连接生命周期管理**: WebSocket 连接的建立、维护、断开重连需要特殊处理
- **错误处理**: WebSocket 连接的错误类型和处理方式与 HTTP 代理不同
- **超时处理**: 需要合理设置 WebSocket 连接的超时时间，避免长时间阻塞

## 成功标准

1. **功能完整性**: 能够通过命令行参数指定 WebSocket 上游代理
2. **配置灵活性**: 能够通过配置文件配置 WebSocket 上游代理
3. **代理转发能力**: WebSocket 代理能够正常转发 HTTP/HTTPS 请求
4. **兼容性保证**: 保持现有功能的完整性和向后兼容性
5. **文档完备性**: 提供完整的文档和使用示例
6. **稳定性**: WebSocket 连接稳定，错误处理完善
7. **性能**: 连接建立和转发性能满足基本使用需求

## 参考资料

### 核心参考资料

1. **[Golang 中如何使用 http,socket5 代理](https://www.cnblogs.com/WingPig99/p/5929138.html)**
   <mcreference link="https://www.cnblogs.com/WingPig99/p/5929138.html" index="0">0</mcreference>
   - 详细介绍了 Golang 中 HTTP 和 SOCKS5 代理的实现方法
   - **关键启示**: 标准库不支持 WebSocket 代理，需要自定义实现
   - 提供了`golang.org/x/net/proxy`包的使用示例

### 相关技术文档

2. **[Golang net/http 包官方文档](https://golang.org/pkg/net/http/)**

   - HTTP Transport 和 Proxy 相关接口说明
   - 标准库代理支持的局限性

3. **[Golang net 包官方文档](https://golang.org/pkg/net/)**

   - 网络连接和 Dialer 接口说明
   - 自定义网络连接的实现方法

4. **[WebSocket 协议 RFC 6455](https://tools.ietf.org/html/rfc6455)**
   - WebSocket 协议标准规范
   - 握手协议和消息帧格式说明

### 实现参考

5. **[golang.org/x/net/proxy 包源码](https://github.com/golang/net/tree/master/proxy)**

   - 代理接口的标准实现
   - SOCKS5 代理的实现参考

6. **[gorilla/websocket 库](https://github.com/gorilla/websocket)**
   - 流行的 WebSocket 客户端库
   - WebSocket 连接管理的最佳实践

### 重要技术要点总结

根据参考资料，以下是实现 WebSocket 代理的关键技术要点：

#### 标准库限制

- Golang 标准库的`http.Transport.Proxy`函数只支持 HTTP 和 SOCKS 代理<mcreference link="https://www.cnblogs.com/WingPig99/p/5929138.html" index="0">0</mcreference>
- 不能使用`http.ProxyURL()`来配置 WebSocket 代理
- 需要自定义实现`http.Transport.Dial`或`http.Transport.DialContext`方法

#### 实现方案

```go
// 错误的方式 - 标准库不支持
transport := &http.Transport{
    Proxy: http.ProxyURL(websocketProxyURL), // 这不会工作
}

// 正确的方式 - 自定义Dialer
transport := &http.Transport{
    DialContext: func(ctx context.Context, network, addr string) (net.Conn, error) {
        // 使用WebSocket客户端建立连接
        return websocketClient.Dial(network, addr)
    },
}
```

#### 集成建议

1. **使用专门的 WebSocket 客户端库**:
   如`gorilla/websocket`或项目指定的`socks5-websocket-proxy-golang`
2. **实现连接池**: 管理 WebSocket 连接的生命周期，提高性能
3. **错误重试机制**: 实现连接失败时的重试逻辑
4. **超时控制**: 设置合理的连接和读写超时
5. **日志记录**: 添加详细的连接状态和错误日志

#### 配置设计原则

1. **向后兼容**: 新增的`type`字段默认值为`"http"`，保持现有配置不变
2. **类型安全**: 使用枚举或常量定义代理类型，避免配置错误
3. **验证机制**: 在配置加载时验证 WebSocket 代理参数的完整性
4. **灵活切换**: 支持运行时动态切换代理类型

## 编译程序,并检查是否有错误

```bash

go build -v ./...

```
