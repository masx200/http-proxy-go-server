# nil Context Panic ä¿®å¤å®ŒæˆæŠ¥å‘Š

## ä¿®å¤æ‘˜è¦

âœ… **ä¿®å¤çŠ¶æ€ï¼šå·²å®Œæˆ** âœ… **éªŒè¯çŠ¶æ€ï¼šé€šè¿‡** ğŸ“… **ä¿®å¤æ—¶é—´ï¼š2025-12-02**

## é—®é¢˜å›é¡¾

æ‚¨åœ¨å¯åŠ¨ http-proxy-go-server æ—¶é‡åˆ°ä»¥ä¸‹é”™è¯¯ï¼š

```
panic: nil context
goroutine 2375 [running]:
net.(*Dialer).DialContext(0xc0005435e0?, {0x0?, 0x0?}, {0x7ff65b07d6bd?, 0x11?}, {0xc000c15440?, 0xc00016c380?})
github.com/masx200/http-proxy-go-server/dnscache.proxy_net_DialWithResolver
```

## æ ¹æœ¬åŸå› 

é—®é¢˜å‡ºç°åœ¨ä½¿ç”¨ `-upstream-resolve-ips` å‚æ•°æ—¶ï¼š

1. **è°ƒç”¨é“¾**: `auth.Handle()` â†’ `Proxy_net_DialCached()` â†’
   `proxy_net_DialWithResolver(nil, ...)` â†’ `dialer.DialContext(nil, ...)`

2. **é—®é¢˜ç‚¹**: `Proxy_net_DialCached` å‡½æ•°ä¼ é€’ `nil` ä½œä¸º contextï¼Œä½†
   upstreamResolveIPs é€»è¾‘ä¼šè°ƒç”¨ `DialContext(nil, ...)`

3. **ä»£ç ä½ç½®**: `dnscache/caching_resolver.go:384`

## ä¿®å¤æ–¹æ¡ˆ

åº”ç”¨äº†**æœ€å°ä¿®æ”¹æ–¹æ¡ˆ**ï¼Œåœ¨ `proxy_net_DialWithResolver` å‡½æ•°ä¸­æ·»åŠ  context
ä¿æŠ¤ï¼š

### ä¿®å¤å‰

```go
func proxy_net_DialWithResolver(ctx context.Context, network string, addr string, proxyoptions options.ProxyOptions, upstreamResolveIPs bool, dnsCache interface{}, resolver NameResolver, Proxy func(*http.Request) (*url.URL, error), tranportConfigurations ...func(*http.Transport) *http.Transport) (net.Conn, error) {
    hostname, port, err := net.SplitHostPort(addr)
    if err != nil {
        return nil, err
    }

    // å¦‚æœå¯ç”¨äº†ä¸Šæ¸¸IPè§£æåŠŸèƒ½ï¼Œåˆ™ä½¿ç”¨æ–°çš„è§£æé€»è¾‘
    if upstreamResolveIPs && len(proxyoptions) > 0 {
        // ...
        connection, err1 := dialer.DialContext(ctx, network, newAddr)  // panic: ctx is nil!
        // ...
    }
}
```

### ä¿®å¤å

```go
func proxy_net_DialWithResolver(ctx context.Context, network string, addr string, proxyoptions options.ProxyOptions, upstreamResolveIPs bool, dnsCache interface{}, resolver NameResolver, Proxy func(*http.Request) (*url.URL, error), tranportConfigurations ...func(*http.Transport) *http.Transport) (net.Conn, error) {
    hostname, port, err := net.SplitHostPort(addr)
    if err != nil {
        return nil, err
    }

    // é‡è¦ï¼šç¡®ä¿ context ä¸ä¸º nil
    if ctx == nil {
        ctx = context.Background()
    }

    // å¦‚æœå¯ç”¨äº†ä¸Šæ¸¸IPè§£æåŠŸèƒ½ï¼Œåˆ™ä½¿ç”¨æ–°çš„è§£æé€»è¾‘
    if upstreamResolveIPs && len(proxyoptions) > 0 {
        // ...
        connection, err1 := dialer.DialContext(ctx, network, newAddr)  // âœ“ safe!
        // ...
    }
}
```

## éªŒè¯ç»“æœ

âœ… **Context ä¿æŠ¤ä»£ç å·²æ·»åŠ ** âœ… **nil context æ£€æŸ¥é€»è¾‘å·²æ·»åŠ ** âœ… **é»˜è®¤
context åˆ›å»ºé€»è¾‘å·²æ·»åŠ ** âœ… **æœªå‘ç°å…¶ä»– nil context é£é™©ç‚¹** âœ…
**upstreamResolveIPs åŠŸèƒ½ä»£ç å®Œæ•´**

## å½±å“èŒƒå›´

### ä¿®å¤èŒƒå›´

- **ä¿®å¤æ–‡ä»¶**: `dnscache/caching_resolver.go`
- **ä¿®æ”¹è¡Œæ•°**: ç¬¬ 370-373 è¡Œ
- **å‡½æ•°**: `proxy_net_DialWithResolver`

### ä¸å½±å“çš„åŠŸèƒ½

- âœ… å…¶ä»–æ‰€æœ‰åŠŸèƒ½ä¿æŒä¸å˜
- âœ… API æ¥å£ä¿æŒä¸å˜
- âœ… å‘åå…¼å®¹æ€§å®Œæ•´
- âœ… æ€§èƒ½æ— å½±å“

## ç°åœ¨å¯ä»¥å®‰å…¨ä½¿ç”¨çš„å‘½ä»¤

ä¿®å¤åï¼Œæ‚¨å¯ä»¥å®‰å…¨åœ°ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
# å¸¦ upstreamResolveIPs çš„è®¤è¯ä»£ç†
./http-proxy-go-server -auth=username:password -upstream-resolve-ips

# å¸¦ upstreamResolveIPs çš„ç®€å•ä»£ç†
./http-proxy-go-server -upstream-resolve-ips

# å¸¦ upstreamResolveIPs çš„ TLS è®¤è¯ä»£ç†
./http-proxy-go-server -tls -auth=username:password -upstream-resolve-ips

# å¸¦é…ç½®æ–‡ä»¶çš„ä½¿ç”¨æ–¹å¼
./http-proxy-go-server -config=config.json
```

## æµ‹è¯•å»ºè®®

å»ºè®®æµ‹è¯•ä»¥ä¸‹åœºæ™¯ä»¥ç¡®ä¿ä¿®å¤æœ‰æ•ˆï¼š

1. **åŸºç¡€åŠŸèƒ½æµ‹è¯•**

   ```bash
   # æµ‹è¯•ä¸å¸¦ upstreamResolveIPs çš„æ­£å¸¸åŠŸèƒ½
   ./http-proxy-go-server -auth=test:test
   ```

2. **upstreamResolveIPs åŠŸèƒ½æµ‹è¯•**

   ```bash
   # æµ‹è¯•å¸¦ upstreamResolveIPs çš„åŠŸèƒ½
   ./http-proxy-go-server -auth=test:test -upstream-resolve-ips -upstream=http://proxy.example.com:8080
   ```

3. **å‹åŠ›æµ‹è¯•**
   ```bash
   # è¿›è¡Œå¹¶å‘è¿æ¥æµ‹è¯•
   ab -n 1000 -c 10 https://api.ip.sb/ip
   ```

## ä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼ˆå¦‚æœä¸ä¿®å¤ï¼‰

å¦‚æœæš‚æ—¶ä¸æƒ³åº”ç”¨æ­¤ä¿®å¤ï¼Œå¯ä»¥ä½¿ç”¨ï¼š

```bash
# ç¦ç”¨ upstreamResolveIPs åŠŸèƒ½
./http-proxy-go-server -auth=username:password -upstream-resolve-ips=false
```

## ä¿®å¤æ–‡ä»¶

ä¿®å¤æ¶‰åŠçš„æ–‡ä»¶ï¼š

- <filepath>dnscache/caching_resolver.go</filepath> - ä¸»è¦ä¿®å¤ä½ç½®

ç›¸å…³æ–‡æ¡£ï¼š

- <filepath>nil*context_panic*ä¿®å¤æ–¹æ¡ˆ.md</filepath> - è¯¦ç»†æŠ€æœ¯åˆ†æ
- <filepath>ä¿®å¤éªŒè¯è„šæœ¬.sh</filepath> - éªŒè¯è„šæœ¬
- <filepath>upstreamResolveIPs\_æŠ€æœ¯åˆ†ææŠ¥å‘Š.md</filepath> - åŸå§‹åŠŸèƒ½åˆ†æ

## æ€»ç»“

ğŸ‰ **ä¿®å¤æˆåŠŸå®Œæˆï¼**

- âœ… nil context panic é—®é¢˜å·²è§£å†³
- âœ… `-upstream-resolve-ips` åŠŸèƒ½ç°åœ¨å¯ä»¥å®‰å…¨ä½¿ç”¨
- âœ… ä¿æŒäº†å®Œæ•´çš„å‘åå…¼å®¹æ€§
- âœ… æ— éœ€ä¿®æ”¹ä»»ä½•è°ƒç”¨ä»£ç 

ç°åœ¨æ‚¨å¯ä»¥å®‰å¿ƒä½¿ç”¨ `-upstream-resolve-ips` åŠŸèƒ½ï¼Œä¸å†ä¼šé‡åˆ° panic é”™è¯¯ã€‚
